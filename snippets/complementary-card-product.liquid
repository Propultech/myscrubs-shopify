{% comment %}
  Renderiza un card de producto para la sección de productos complementarios
  
  Basado en card-product pero con estructura de columnas personalizada
  
  Acepta los mismos parámetros que card-product:
  - card_product: {Object} Objeto Liquid del producto
  - show_vendor: {Boolean} Mostrar el vendor del producto
  - quick_add: {Boolean} Mostrar el botón de añadir rápido
  - section_id: {String} ID de la sección que contiene esta tarjeta
  ... etc.
{% endcomment %}

{%- unless skip_styles -%}
  {{ 'component-rating.css' | asset_url | stylesheet_tag }}
  {{ 'component-volume-pricing.css' | asset_url | stylesheet_tag }}
  {{ 'component-price.css' | asset_url | stylesheet_tag }}
  {{ 'component-swatch.css' | asset_url | stylesheet_tag }}
  {{ 'quick-order-list.css' | asset_url | stylesheet_tag }}
  {{ 'quantity-popover.css' | asset_url | stylesheet_tag }}
{%- endunless -%}

{%- if card_product and card_product != empty -%}
  <article class="complementary-item">
    <!-- Columna 1: Imagen del producto -->
    <div class="complementary-item__column complementary-item__image-wrapper">
      {%- if card_product.featured_media -%}
        <a href="{{ card_product.url }}" class="complementary-item__image-link">
          <img
            srcset="
              {%- if card_product.featured_media.width >= 165 -%}{{ card_product.featured_media | image_url: width: 165 }} 165w,{%- endif -%}
              {%- if card_product.featured_media.width >= 360 -%}{{ card_product.featured_media | image_url: width: 360 }} 360w,{%- endif -%}
              {%- if card_product.featured_media.width >= 533 -%}{{ card_product.featured_media | image_url: width: 533 }} 533w,{%- endif -%}
              {{ card_product.featured_media | image_url }} {{ card_product.featured_media.width }}w
            "
            src="{{ card_product.featured_media | image_url: width: 533 }}"
            sizes="(min-width: 990px) 30vw, 50vw"
            alt="{{ card_product.featured_media.alt | escape }}"
            class="complementary-item__image"
            loading="lazy"
            width="{{ card_product.featured_media.width }}"
            height="{{ card_product.featured_media.height }}"
          >
          
          {%- if card_product.media[1] != null and show_secondary_image -%}
            <img
              srcset="
                {%- if card_product.media[1].width >= 165 -%}{{ card_product.media[1] | image_url: width: 165 }} 165w,{%- endif -%}
                {%- if card_product.media[1].width >= 360 -%}{{ card_product.media[1] | image_url: width: 360 }} 360w,{%- endif -%}
                {%- if card_product.media[1].width >= 533 -%}{{ card_product.media[1] | image_url: width: 533 }} 533w,{%- endif -%}
                {{ card_product.media[1] | image_url }} {{ card_product.media[1].width }}w
              "
              src="{{ card_product.media[1] | image_url: width: 533 }}"
              sizes="(min-width: 990px) 30vw, 50vw"
              alt="{{ card_product.media[1].alt | escape }}"
              class="complementary-item__image complementary-item__image--secondary"
              loading="lazy"
              width="{{ card_product.media[1].width }}"
              height="{{ card_product.media[1].height }}"
            >
          {%- endif -%}
        </a>
      {%- else -%}
        <div class="complementary-item__image-placeholder">
          {{ 'product-apparel-2' | placeholder_svg_tag: 'placeholder-svg' }}
        </div>
      {%- endif -%}
      
      <div class="complementary-item__badge">
        {%- if card_product.available == false -%}
          <span class="badge badge--sold-out color-{{ settings.sold_out_badge_color_scheme }}">
            {{- 'products.product.sold_out' | t -}}
          </span>
        {%- elsif card_product.compare_at_price > card_product.price and card_product.available -%}
          <span class="badge badge--sale color-{{ settings.sale_badge_color_scheme }}">
            {{- 'products.product.on_sale' | t -}}
          </span>
        {%- endif -%}
      </div>
    </div>
    
    <!-- Columna 2: Información del producto -->
    <div class="complementary-item__column complementary-item__info">
      {%- if show_vendor -%}
        <span class="complementary-item__vendor">
          {{ card_product.vendor }}
        </span>
      {%- endif -%}
      
      <h3 class="complementary-item__title">
        <a href="{{ card_product.url }}" class="complementary-item__title-link">
          {{ card_product.title | escape }}
        </a>
      </h3>
      
      <div class="complementary-item__price">
        {% render 'price', product: card_product, price_class: '', show_compare_at_price: true %}
      </div>
      
      {%- if show_rating and card_product.metafields.reviews.rating.value != blank -%}
        {% liquid
          assign rating_decimal = 0
          assign decimal = card_product.metafields.reviews.rating.value.rating | modulo: 1
          if decimal >= 0.3 and decimal <= 0.7
            assign rating_decimal = 0.5
          elsif decimal > 0.7
            assign rating_decimal = 1
          endif
        %}
        <div
          class="rating"
          role="img"
          aria-label="{{ 'accessibility.star_reviews_info' | t: rating_value: card_product.metafields.reviews.rating.value, rating_max: card_product.metafields.reviews.rating.value.scale_max }}"
        >
          <span
            aria-hidden="true"
            class="rating-star"
            style="--rating: {{ card_product.metafields.reviews.rating.value.rating | floor }}; --rating-max: {{ card_product.metafields.reviews.rating.value.scale_max }}; --rating-decimal: {{ rating_decimal }};"
          ></span>
        </div>
        <p class="rating-text caption">
          <span aria-hidden="true">
            {{- card_product.metafields.reviews.rating.value }} /
            {{ card_product.metafields.reviews.rating.value.scale_max -}}
          </span>
        </p>
      {%- endif -%}
      
      {% comment %}Render product color swatches{% endcomment %}
      {% render 'card-product-swatches', card_product: card_product, max_swatches: 5 %}
    </div>
    
    <!-- Columna 3: Acción (Botón de compra) -->
    <div class="complementary-item__column complementary-item__action">
      {% assign product_form_id = 'complementary-product-' | append: section_id | append: card_product.id %}
      
      {% if quick_add == 'standard' %}
        <div class="complementary-item__quick-add">
          {%- if card_product.variants_count > 1 or card_product.selected_or_first_available_variant.quantity_rule.min > 1 or card_product.selected_or_first_available_variant.quantity_rule.max != null or card_product.selected_or_first_available_variant.quantity_rule.increment > 1 -%}
            <modal-opener data-modal="#QuickAdd-{{ card_product.id }}">
              <button
                id="{{ product_form_id }}-submit"
                type="submit"
                name="add"
                class="complementary-item__choose-options"
                aria-haspopup="dialog"
                aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
                data-product-url="{{ card_product.url }}"
              >
                {{ 'products.product.choose_options' | t }}
                {%- render 'loading-spinner' -%}
              </button>
            </modal-opener>
            <quick-add-modal id="QuickAdd-{{ card_product.id }}" class="quick-add-modal">
              <div
                role="dialog"
                aria-label="{{ 'products.product.choose_product_options' | t: product_name: card_product.title | escape }}"
                aria-modal="true"
                class="quick-add-modal__content global-settings-popup"
                tabindex="-1"
              >
                <button
                  id="ModalClose-{{ card_product.id }}"
                  type="button"
                  class="quick-add-modal__toggle"
                  aria-label="{{ 'accessibility.close' | t }}"
                >
                  {{- 'icon-close.svg' | inline_asset_content -}}
                </button>
                <div id="QuickAddInfo-{{ card_product.id }}" class="quick-add-modal__content-info"></div>
              </div>
            </quick-add-modal>
          {%- else -%}
            <product-form data-section-id="{{ section.id }}">
              {%- form 'product',
                card_product,
                id: product_form_id,
                class: 'form',
                novalidate: 'novalidate',
                data-type: 'add-to-cart-form'
              -%}
                <input
                  type="hidden"
                  name="id"
                  value="{{ card_product.selected_or_first_available_variant.id }}"
                  class="product-variant-id"
                  {% if card_product.selected_or_first_available_variant.available == false %}
                    disabled
                  {% endif %}
                >
                <button
                  id="{{ product_form_id }}-submit"
                  type="submit"
                  name="add"
                  class="complementary-item__add-to-cart"
                  aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
                  aria-live="polite"
                  data-sold-out-message="true"
                  {% if card_product.selected_or_first_available_variant.available == false %}
                    disabled
                  {% endif %}
                >
                  <span>
                    {%- if card_product.selected_or_first_available_variant.available -%}
                      {{ 'products.product.add_to_cart' | t }}
                    {%- else -%}
                      {{ 'products.product.sold_out' | t }}
                    {%- endif -%}
                  </span>
                  <span class="sold-out-message hidden">
                    {{ 'products.product.sold_out' | t }}
                  </span>
                  {%- render 'loading-spinner' -%}
                </button>
              {%- endform -%}
            </product-form>
          {%- endif -%}
        </div>
      {% endif %}
    </div>
  </article>
{%- else -%}
  <article class="complementary-item complementary-item--placeholder">
    <div class="complementary-item__column complementary-item__image-wrapper">
      <div class="complementary-item__image-placeholder">
        {{ 'product-apparel-2' | placeholder_svg_tag: 'placeholder-svg' }}
      </div>
    </div>
    
    <div class="complementary-item__column complementary-item__info">
      {%- if show_vendor -%}
        <span class="complementary-item__vendor">
          {{ 'products.product.vendor' | t }}
        </span>
      {%- endif -%}
      
      <h3 class="complementary-item__title">
        <a role="link" aria-disabled="true" class="complementary-item__title-link">
          {{ 'onboarding.product_title' | t }}
        </a>
      </h3>
      
      <div class="complementary-item__price">
        {% render 'price', placeholder: true, show_compare_at_price: true %}
      </div>
    </div>
    
    <div class="complementary-item__column complementary-item__action">
      <button type="button" class="complementary-item__add-to-cart" disabled>
        {{ 'products.product.add_to_cart' | t }}
      </button>
    </div>
  </article>
{%- endif -%}